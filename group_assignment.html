<!-- ✅ group_assignment.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Group Assignment | CollabSync</title>
  <link rel="stylesheet" href="styles/css/managerdash1.css">
  <style>
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
    .modal-content { background-color: #fff; margin: 10% auto; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); animation: fadeIn 0.3s ease-in-out; }
    .modal-content h3 { margin-bottom: 15px; }
    .modal-content input, .modal-content select { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 6px; }
    .modal-content button { padding: 10px 16px; margin-top: 10px; border: none; border-radius: 6px; cursor: pointer; }
    .save-btn { background-color: #27ae60; color: white; }
    .cancel-btn { background-color: #e74c3c; color: white; float: right; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .delete-btn { background-color: #e74c3c; color: white; padding: 6px 12px; border-radius: 5px; border: none; cursor: pointer; margin-top: 10px; }
  </style>
</head>
<body>
  <nav class="navbar">
    <span class="navbar-brand">CollabSync</span>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </nav>

  <div class="container">
    <h2>Group Assignment</h2>
    <button class="save-btn" onclick="openModal()">+ Create Group</button>

    <div id="groupContainer" class="employee-grid"></div>
  </div>

  <!-- Create Group Modal -->
  <div id="groupModal" class="modal">
    <div class="modal-content">
      <h3>Create a New Group</h3>
      <input type="text" id="groupName" placeholder="Group Name" />
      <select id="groupMembers" multiple></select>
      <button class="save-btn" onclick="saveGroup()">Save</button>
      <button class="cancel-btn" onclick="closeModal()">Cancel</button>
    </div>
  </div>

  <script>
    const managerId = localStorage.getItem("userId");

    async function fetchGroups() {
      const res = await fetch("https://collabsync-backend-i376.onrender.com/api/groups");
      const groups = await res.json();
      const container = document.getElementById("groupContainer");
      container.innerHTML = "";

      groups.forEach(group => {
        const card = document.createElement("div");
        card.className = "employee-card";
        const memberList = group.members.map(m => `${m.name} (${m._id})`).join(", ");
        card.innerHTML = `<h4>${group.name}</h4><p>Members: ${memberList}</p>
          <button class='delete-btn' onclick='deleteGroup("${group._id}")'>Delete Group</button>`;
        container.appendChild(card);
      });
    }

    function openModal() {
      document.getElementById("groupModal").style.display = "block";
      populateMemberOptions();
    }

    function closeModal() {
      document.getElementById("groupModal").style.display = "none";
      document.getElementById("groupName").value = "";
      document.getElementById("groupMembers").innerHTML = "";
    }

    async function populateMemberOptions() {
      const select = document.getElementById("groupMembers");
      const res = await fetch(`https://collabsync-backend-i376.onrender.com/api/users/assigned/${managerId}`);
      const users = await res.json();
      users.forEach(user => {
        const option = document.createElement("option");
        option.value = user._id;
        option.textContent = `${user.name} (${user._id})`;
        select.appendChild(option);
      });
    }

    async function saveGroup() {
      const name = document.getElementById("groupName").value.trim();
      const selectedOptions = document.getElementById("groupMembers").selectedOptions;
      const members = Array.from(selectedOptions).map(opt => opt.value);

      if (!name || members.length === 0) {
        alert("Please provide a group name and select members.");
        return;
      }

      const res = await fetch("https://collabsync-backend-i376.onrender.com/api/groups", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, members })
      });

      if (res.ok) {
        closeModal();
        fetchGroups();
      } else {
        alert("❌ Failed to create group.");
      }
    }

    async function deleteGroup(id) {
      const confirmed = confirm("Are you sure you want to delete this group?");
      if (!confirmed) return;

      const res = await fetch(`https://collabsync-backend-i376.onrender.com/api/groups/${id}`, {
        method: "DELETE"
      });

      if (res.ok) {
        fetchGroups();
      } else {
        alert("❌ Failed to delete group.");
      }
    }

    function logout() {
      localStorage.clear();
      window.location.href = "Auth_page.html";
    }

    fetchGroups();
  </script>
</body>
</html>
